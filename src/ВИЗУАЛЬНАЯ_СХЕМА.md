# 📊 ВИЗУАЛЬНАЯ СХЕМА: Как всё работает

## 🎬 Полный процесс обработки видео

```
┌──────────────────────────────────────────────────────────────────┐
│                        ВЫ (Пользователь)                         │
│                                                                  │
│  1. Перетаскиваете видео                                        │
│  2. Нажимаете "Анализировать"                                   │
│  3. Видите красивую анимацию загрузки                           │
│  4. Получаете результат!                                        │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                    FRONTEND (Браузер)                            │
│                    /App.tsx + /lib/api.ts                        │
│                                                                  │
│  • Принимает видео через drag & drop                            │
│  • Валидирует файл (формат, размер)                             │
│  • Отправляет на backend                                        │
│  • Показывает прогресс                                          │
│  • Отображает результаты                                        │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            │ fetch('http://localhost:3001/api/analyze')
                            │ FormData: video file
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                   BACKEND (Node.js)                              │
│                   server.js на localhost:3001                    │
│                                                                  │
│  1. Получает видео                                              │
│  2. Проверяет формат и размер                                   │
│  3. Конвертирует в base64                                       │
│  4. Отправляет в Google AI                                      │
│  5. Ждет ответ (~30-60 сек)                                     │
│  6. Парсит JSON                                                 │
│  7. Возвращает результат frontend                               │
│                                                                  │
│  🔑 ХРАНИТ API КЛЮЧ В БЕЗОПАСНОСТИ!                             │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            │ Google Generative AI SDK
                            │ model.generateContent([video, prompt])
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                  GOOGLE AI (Gemini)                              │
│                  gemini-1.5-flash                                │
│                                                                  │
│  1. Получает видео в base64                                     │
│  2. Анализирует:                                                │
│     • Визуальный ряд (кадры, монтаж)                            │
│     • Аудио (речь, музыка)                                      │
│     • Структуру контента                                        │
│  3. Транскрибирует речь                                         │
│  4. Переводит на русский                                        │
│  5. Создает сценарий                                            │
│  6. Генерирует рекомендации                                     │
│  7. Возвращает JSON с результатом                               │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            │ JSON response
                            ▼
                       (обратно в Backend)
                            │
                            ▼
                       (обратно в Frontend)
                            │
                            ▼
                         ВЫ видите результат! 🎉
```

---

## 🔄 Детальный поток данных

### Этап 1: Загрузка видео

```
Пользователь
    │
    │ [перетаскивает video.mp4]
    ▼
UploadPage.tsx
    │
    │ onFileUpload(file)
    ▼
App.tsx
    │
    │ setUploadedFile(file)
    │ handleAnalyze()
    ▼
processVideo(file) ← /lib/api.ts
```

### Этап 2: Отправка на backend

```
/lib/api.ts
    │
    │ const formData = new FormData()
    │ formData.append('video', file)
    ▼
fetch('http://localhost:3001/api/analyze', {
    method: 'POST',
    body: formData
})
    │
    │ [HTTP POST]
    ▼
Backend (server.js)
```

### Этап 3: Обработка на backend

```
Express Server
    │
    │ app.post('/api/analyze', ...)
    ▼
Multer (получение файла)
    │
    │ req.file = { buffer, mimetype, size, ... }
    ▼
Валидация
    │
    │ • Проверка размера
    │ • Проверка формата
    ▼
Конвертация в Base64
    │
    │ const videoBase64 = req.file.buffer.toString('base64')
    ▼
Google AI SDK
    │
    │ const model = genAI.getGenerativeModel({
    │   model: 'gemini-1.5-flash'
    │ })
    ▼
Отправка в Google
    │
    │ model.generateContent([
    │   { inlineData: { data: videoBase64, mimeType: 'video/mp4' }},
    │   { text: ANALYSIS_PROMPT }
    │ ])
    ▼
Ожидание... (~30-60 сек)
```

### Этап 4: Ответ от Google AI

```
Google AI
    │
    │ [анализирует видео]
    │ [генерирует JSON]
    ▼
Response
    │
    │ {
    │   "original": { "transcription": "...", "translation": "..." },
    │   "keys": [...],
    │   "script": [...],
    │   "recommendations": [...]
    │ }
    ▼
Backend (server.js)
    │
    │ const text = response.text()
    │ const data = JSON.parse(text)
    ▼
Валидация JSON
    │
    │ • Проверка структуры
    │ • Проверка полей
    ▼
Отправка клиенту
    │
    │ res.json(data)
    ▼
Frontend
```

### Этап 5: Отображение результатов

```
Frontend (/lib/api.ts)
    │
    │ const result = await response.json()
    ▼
App.tsx
    │
    │ setAnalysisResult(result)
    │ setAppState('results')
    ▼
ResultsPage.tsx
    │
    │ Рендерит 4 блока:
    │ • Транскрибация
    │ • Ключи к успеху
    │ • Сценарий
    │ • Рекомендации
    ▼
Пользователь видит результат! 🎊
```

---

## 🗂️ Структура данных на каждом этапе

### 1. Frontend → Backend

```http
POST /api/analyze HTTP/1.1
Host: localhost:3001
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

------WebKitFormBoundary
Content-Disposition: form-data; name="video"; filename="test.mp4"
Content-Type: video/mp4

[binary video data...]
------WebKitFormBoundary--
```

### 2. Backend → Google AI

```javascript
{
  parts: [
    {
      inlineData: {
        mimeType: "video/mp4",
        data: "UklGRiQAAABXQVZFZm10IBAAAAABAAE..." // base64
      }
    },
    {
      text: "Ты — профессиональный SMM-аналитик..."
    }
  ]
}
```

### 3. Google AI → Backend

```json
{
  "original": {
    "transcription": "Hey everyone! Today I'm going to show you...",
    "translation": "Привет всем! Сегодня я покажу вам..."
  },
  "keys": [
    {
      "title": "Мощный хук",
      "description": "Видео начинается с интригующего вопроса..."
    }
  ],
  "script": [
    {
      "time": "0-3 сек",
      "visual": "Крупный план лица",
      "text": "Хотите узнать секрет?",
      "note": "Интригующий вопрос"
    }
  ],
  "recommendations": [
    {
      "category": "Интонация",
      "text": "Используйте энергичный тон..."
    }
  ]
}
```

### 4. Backend → Frontend

```json
{
  "original": {...},
  "keys": [...],
  "script": [...],
  "recommendations": [...],
  "_metadata": {
    "processingTime": "35.42",
    "fileSize": "8.50",
    "fileName": "test.mp4",
    "timestamp": "2025-11-09T10:30:00.000Z"
  }
}
```

---

## 🔐 Безопасность: Почему Backend обязателен

### ❌ ПЛОХО: API ключ на Frontend

```
┌─────────────┐
│   Браузер   │ 
│             │ → const API_KEY = "AIzaSyB..." ← 😱 ВИДНО ВСЕМ!
│  (Frontend) │
└─────────────┘
       │
       │ Любой может:
       │ • Открыть DevTools (F12)
       │ • Посмотреть код
       │ • Украсть ключ
       │ • Потратить ваши деньги
       ▼
   💸💸💸 Проблемы!
```

### ✅ ХОРОШО: API ключ на Backend

```
┌─────────────┐
│   Браузер   │ 
│  (Frontend) │ ← Код виден, но ключа нет! 😊
└──────┬──────┘
       │
       │ fetch('http://localhost:3001/api/analyze')
       ▼
┌─────────────┐
│   Backend   │
│  (Node.js)  │ ← API_KEY в .env (скрыт от всех)
└──────┬──────┘
       │
       │ Отправляет в Google с ключом
       ▼
┌─────────────┐
│  Google AI  │
└─────────────┘

✅ Никто не может украсть ключ
✅ Вы контролируете доступ
✅ Безопасно!
```

---

## 📦 Файлы и их роль

```
┌─────────────────────────────────────────────────────────────┐
│ FRONTEND (React + TypeScript)                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  /App.tsx                  ← Главный компонент             │
│  ├─ Управляет состоянием (upload/processing/results)       │
│  └─ Переключает страницы                                   │
│                                                             │
│  /components/UploadPage.tsx    ← Загрузка видео            │
│  ├─ Drag & Drop зона                                       │
│  ├─ Валидация файла                                        │
│  └─ Кнопка "Анализировать"                                 │
│                                                             │
│  /components/ProcessingPage.tsx ← Экран загрузки           │
│  ├─ Анимация                                               │
│  └─ Прогресс-бар                                           │
│                                                             │
│  /components/ResultsPage.tsx   ← Результаты                │
│  ├─ Транскрибация                                          │
│  ├─ Ключи к успеху                                         │
│  ├─ Сценарий                                               │
│  └─ Рекомендации                                           │
│                                                             │
│  /lib/api.ts               ← API клиент                    │
│  ├─ processVideo(file)    ← Отправка на backend           │
│  ├─ VideoAnalysisResult   ← Типы данных                   │
│  └─ API_CONFIG            ← Настройки                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ BACKEND (Node.js + Express)                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  /server.js                ← Главный файл                  │
│  ├─ Express сервер                                         │
│  ├─ Multer (загрузка файлов)                               │
│  ├─ Google AI SDK                                          │
│  └─ POST /api/analyze     ← Эндпоинт                       │
│                                                             │
│  /.env                     ← Секреты                       │
│  ├─ GOOGLE_AI_API_KEY     ← API ключ                      │
│  ├─ PORT                  ← Порт сервера                   │
│  └─ FRONTEND_URL          ← URL frontend                   │
│                                                             │
│  /package.json             ← Зависимости                   │
│  ├─ express                                                │
│  ├─ cors                                                   │
│  ├─ dotenv                                                 │
│  ├─ multer                                                 │
│  └─ @google/generative-ai                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## ⏱️ Тайминги процесса

```
Действие                          Время      Где происходит
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Выбор видео                    1 сек      Frontend
2. Валидация (формат, размер)     < 1 сек    Frontend
3. Отправка на backend            1-2 сек    Frontend → Backend
4. Получение на backend           < 1 сек    Backend
5. Конвертация в base64           2-5 сек    Backend
6. Отправка в Google AI           1-2 сек    Backend → Google
7. Анализ видео в Google AI       30-60 сек  Google AI
8. Получение ответа               1-2 сек    Google → Backend
9. Парсинг JSON                   < 1 сек    Backend
10. Отправка клиенту              1-2 сек    Backend → Frontend
11. Отображение результатов       < 1 сек    Frontend
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ИТОГО:                            40-70 сек  (в основном Google AI)
```

---

## 🎯 Критические точки

### 1. Потеря соединения

```
Frontend → Backend ✅
Backend → Google ❌ (timeout)
Backend → Frontend ✅ (ошибка)
```

**Решение:** Retry механизм, увеличение timeout

### 2. Превышение квоты

```
Backend → Google ❌ (quota exceeded)
```

**Решение:** Rate limiting, очередь задач

### 3. Неверный JSON

```
Google → Backend (некорректный JSON)
Backend → парсинг ❌
```

**Решение:** Обработка ошибок, fallback

---

## 🔄 Альтернативные архитектуры

### Вариант 1: С облачным хранилищем

```
Frontend → Backend → Cloud Storage → Google AI → Backend → Frontend
                         ↓
                    Временный URL
                    (удаляется через 1 час)
```

**Плюсы:**
- Поддержка больших файлов
- Параллельная обработка
- История загрузок

**Минусы:**
- Дороже
- Сложнее настроить

### Вариант 2: Serverless (Cloud Functions)

```
Frontend → Cloud Function → Google AI → Frontend
```

**Плюсы:**
- Автомасштабирование
- Платите только за использование
- Не нужен сервер 24/7

**Минусы:**
- Cold start (задержка)
- Лимиты времени выполнения

---

**Эта схема поможет вам понять весь процесс!** 🎓

Теперь вы знаете:
- ✅ Как данные путешествуют через систему
- ✅ Зачем нужен каждый компонент
- ✅ Где что хранится
- ✅ Сколько времени занимает каждый этап
